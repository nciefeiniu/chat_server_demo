<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Links - Camera Share</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }

    .header {
      background-color: #007bff;
      color: white;
      padding: 1rem 0;
    }

    .header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header .welcome {
      font-size: 1.5rem;
    }

    .list-item {
      border-bottom: 1px solid #dee2e6;
      padding: 10px;

    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-title {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .list-score {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .list-description {
      color: #6c757d;
    }

    .link-item {
      font-size: 12px;
    margin-left: 30px;
    color: cadetblue;
    }

    .show-link-score {
      /* display: block; */
    }

    .hidden-link-score {
      visibility: hidden;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="welcome">Welcome </div>
      <button class="btn btn-light btn-logout" style="display: none;" onclick="logoutHandle()">Logout</button>
      <a class="btn btn-light btn-login" style="display: none;" href="./login_or_register.html">Login</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mt-5">
    <h1 class="mb-4">Share Links</h1>
    <div class="row">
      <div class="col-md-8">
        <div class="text-end">
          <button class="btn btn-primary btn-sm" id="show-my-favorites" onclick="showMyFavorites()">Show My Favorites</button>
          <button class="btn btn-primary btn-sm hidden-link-score" id="show-all-links" onclick="showAllShareLinks()">Show All</button>
        </div>
        <div class="list-group" id="share-links-container">
         
        </div>
      </div>
      <div class="col-md-4 add-share-link" style="display: none;">
        <h4>Share Link</h4>
        <form id="new-share-form">
          <div class="mb-3">
            <label for="title" class="form-label">Title: </label>
            <input type="text" class="form-control" id="title" name="title" required />
          </div>
          <div class="mb-3">
            <label for="link" class="form-label">Link: </label>
            <input type="text" class="form-control" id="link" name="link" required />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <input type="text" class="form-control" id="description" name="description" required />
          </div>
          <button type="submit" class="btn btn-success">Submit</button>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script>
    const USERNAME = sessionStorage.getItem("username");
    const TOKEN = sessionStorage.getItem("token");
    const FULLNAME = sessionStorage.getItem("fullname");

    var SHOWTYPE = 'index';

    if (FULLNAME) {
      document.querySelector('.welcome').innerHTML = `Welcome ${FULLNAME}`;
      document.querySelector('.btn-logout').style.display = 'block';
      document.querySelector('.add-share-link').style.display = 'block';
    } else {
      document.querySelector('.btn-login').style.display = 'block';
    }

    getAllShareLinks();

    function logoutHandle() {
      // ÈÄÄÂá∫ÁôªÂΩï
      sessionStorage.clear();
      window.location.reload();
    }

    function showMyFavorites() {
      SHOWTYPE = 'favorites';
      getAllShareLinks();
      document.getElementById('show-my-favorites').classList.add('hidden-link-score')
      document.getElementById('show-all-links').classList.remove('hidden-link-score')
    }

    function showAllShareLinks() {
      SHOWTYPE = 'index';
      getAllShareLinks();
      document.getElementById('show-all-links').classList.add('hidden-link-score')
      document.getElementById('show-my-favorites').classList.remove('hidden-link-score')
    }

    function getAllShareLinks() {
      // Ëé∑ÂèñÊâÄÊúâÁöÑÂàÜ‰∫´ÈìæÊé•
      let apiUrl = 'http://127.0.0.1:8050/share_links'
      if (SHOWTYPE === 'favorites') {
        apiUrl = 'http://127.0.0.1:8050/share_links/positive'
      }
      fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Authorization': TOKEN ? `Bearer ${TOKEN}` : ''
        }
      }).then(response => {
        if (response.ok) {
          return response.json()
        } else {
          throw 'Error'
        }
      }).then(data => {
        console.log(data);
        renderShareLinks(data)
      }).catch(error => {
        console.error(error);
      });
    }

    function scoreShareLink(id, score) {
      fetch(`http://127.0.0.1:8050/share_links/score`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': TOKEN ? `Bearer ${TOKEN}` : ''
        },
        body: JSON.stringify({
          id: id,
          score: score
        })
      }).then(response => {
        if (response.ok) {
          return response.json()
        } else if (response.status === 401) {
          window.location.href = './login_or_register.html';
        } else if (response.status === 409) {
          alert('You have already scored this link.');
          throw 'Error'
        } else {
          throw 'Error'
        }
      }).then(data => {
        console.log(data);
        getAllShareLinks();
      }).catch(error => {
        console.error(error);
      });
    }

    function renderShareLinks(data){
      // Ê∏≤ÊüìÂàÜ‰∫´ÈìæÊé•
      const shareLinksContainer = document.getElementById('share-links-container');
      shareLinksContainer.innerHTML = '';
      for (let i=0; i< data.length;i++) {
        const shareLink = data[i];
        shareLinksContainer.innerHTML += `
          <div class="list-group-item list-item">
            <h5 class="list-title">${shareLink.title} <span class="link-item">${shareLink.link}</span></h5>
            <p class="list-score">Total Score: ${shareLink.total_score}</p>
            <p class="list-description">${shareLink.description}</p>
            <div class="row">
              <div class="col-md-8">
                <div class="${USERNAME ? 'show-link-score': 'hidden-link-score'}">
                  <button class="btn btn-link" onclick="scoreShareLink(${shareLink.id}, 1)">üëç</button>
                  <button class="btn btn-link" onclick="scoreShareLink(${shareLink.id}, -1)">üëé</button>  
                </div>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-danger btn-sm ${USERNAME ? 'show-link-score': 'hidden-link-score'}" onclick="hiddenShareLink(${shareLink.id})">Hidden</button>
              </div>
            </div>
          </div>
        `
      }

    }

    function hiddenShareLink(id) {
      fetch(`http://127.0.0.1:8050/share_links/hidden`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': TOKEN ? `Bearer ${TOKEN}` : ''
        },
        body: JSON.stringify({
          id: id
        })
      }).then(response => {
        if (response.ok) {
          return response.json()
        }
        throw 'Error'
      }).then(data => {
        alert('Share Link Hidden Successfully');
        getAllShareLinks();
      }).catch(error => {
        console.error(error);
      });
    }

    document.getElementById('new-share-form').addEventListener('submit', function (e) {
      // Êèê‰∫§Êñ∞ÁöÑÂàÜ‰∫´ÈìæÊé•
      e.preventDefault();
      const jsonData = {
        title: document.getElementById('title').value,
        link: document.getElementById('link').value,
        description: document.getElementById('description').value
      }
      fetch('http://127.0.0.1:8050/share_links', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': TOKEN ? `Bearer ${TOKEN}` : ''
        },
        body: JSON.stringify(jsonData)
      }).then(response => response.json()).then(data => {
        console.log(data);
        alert('Share Link Added Successfully');
        getAllShareLinks()
      })
      
    })

  </script>
</body>

</html>
