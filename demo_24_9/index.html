<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forum App</title>
    <style>
      body {
        font-family: "Open Sans", Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      .hidden {
        display: none;
      }
      .thread-item {
        background-color: #ffffff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .thread-item:hover {
        background-color: #e9ecef;
      }
      .post-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
      }
      .post-item:last-child {
        border-bottom: none;
      }

      .new-post-container input {
        line-height: 22px;
        width: 200px;
      }

      .new-post-container button {
        margin-left: 10px;
        line-height: 22px;
      }
    </style>
  </head>
  <body>
    <div id="login" class="login">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" />
      <button onclick="login()">Login</button>
    </div>

    <div id="app" class="hidden">
      <h2>Thread List</h2>
      <h4></h4>
      <div id="threadsListWap"></div>
    </div>

    <script>
      var user,
        name = null;

      function login() {
        const username = document.getElementById("username").value;
        fetch(`http://127.0.0.1:7777/api/users/${username}`)
          .then((response) => {
            if (response.status === 200) {
              response.json().then((userInfo) => {
                console.log(userInfo);
                document.getElementById("login").classList.add("hidden");
                document.getElementById("app").classList.remove("hidden");
                user = userInfo.username;
                name = userInfo.name;
                window.history.pushState(
                  { page: "threads" },
                  "Threads",
                  "./threads"
                );
                document.querySelector(
                  "h4"
                ).innerHTML = `Logged in as ${userInfo.name}`;
                loadThreads();
              });
            } else {
              alert("User not found");
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // ThreadList Component
      function loadThreads() {
        fetch("http://127.0.0.1:7777/api/threads")
          .then((response) => response.json())
          .then((threads) => {
            const threadsContainerTag =
              document.getElementById("threadsListWap");
            threadsContainerTag.innerHTML = "";
            threads.forEach((thread) => {
              const threadItemContainerTag = document.createElement("div");
              threadItemContainerTag.className = "thread-item";
              threadItemContainerTag.setAttribute("data-thread-id", thread.id);
              threadItemContainerTag.innerHTML = `<strong>${thread.thread_title}</strong>`;
              threadItemContainerTag.onclick = () => loadPosts(thread.id, threadItemContainerTag);
              threadsContainerTag.appendChild(threadItemContainerTag);
            });
          })
          .catch((error) => console.error("Error fetching threads:", error));
      }

      function loadPosts(threadId, threadItemContainerTag) {
        fetch(`http://127.0.0.1:7777/api/threads/${threadId}/posts`)
          .then((response) => response.json())
          .then((threadPostsData) => {
            if (
              document.querySelector(
                `.posts-container[data-thread-id='${threadId}']`
              )
            ) {
              var postsContainerTag = document.querySelector(
                `.posts-container[data-thread-id='${threadId}']`
              );
              postsContainerTag.innerHTML = "";
            } else {
              var postsContainerTag = document.createElement("div");
              postsContainerTag.classList.add("posts-container");
              postsContainerTag.setAttribute("data-thread-id", threadId);
            }

            window.history.pushState(
              { page: "posts", threadId: threadId },
              "Posts",
              "./posts?id" + threadId
            );

            threadPostsData.forEach((post) => {
              const postElement = document.createElement("div");
              postElement.className = "post-item";
              postElement.innerHTML = `${post.text} <br> &nbsp;&nbsp;&nbsp;&nbsp; - ${post.name}`;
              postsContainerTag.appendChild(postElement);
            });
            postsContainerTag.innerHTML += `<div class="new-post-container">
                <input></input><button>Enter</button>
              </div>`

              threadItemContainerTag.appendChild(postsContainerTag);
          })
          .catch((error) => console.error("Error fetching posts:", error));
      }
    </script>
  </body>
</html>
